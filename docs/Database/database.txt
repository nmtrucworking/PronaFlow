-- Tạo các kiểu ENUM tùy chỉnh để tăng tính nhất quán cho dữ liệu
CREATE TYPE theme_preference AS ENUM ('light', 'dark');
CREATE TYPE project_status AS ENUM ('on-hold', 'not-started', 'in-progress', 'in-review', 'done');
CREATE TYPE task_priority AS ENUM ('low', 'normal', 'high');
CREATE TYPE task_status AS ENUM ('not-started', 'in-progress', 'in-review', 'done');
CREATE TYPE activity_action_type AS ENUM ('mention', 'assign', 'change_status', 'comment');
CREATE TYPE activity_target_type AS ENUM ('project', 'task');
CREATE TYPE workspace_role AS ENUM ('owner', 'admin', 'member');
CREATE TYPE project_role AS ENUM ('admin', 'member');

-- Bảng 1: users
-- Lưu trữ thông tin người dùng.
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    avatar_url VARCHAR(255),
    bio TEXT,
    theme theme_preference DEFAULT 'light',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE
);

-- Bảng 2: workspaces
-- Lưu trữ các không gian làm việc.
CREATE TABLE workspaces (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    owner_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Bảng 3: projects
-- Lưu trữ thông tin các dự án.
CREATE TABLE projects (
    id BIGSERIAL PRIMARY KEY,
    workspace_id BIGINT NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    cover_image_url VARCHAR(255),
    status project_status DEFAULT 'not-started',
    start_date DATE,
    end_date DATE,
    is_archived BOOLEAN DEFAULT FALSE,
    is_deleted BOOLEAN DEFAULT FALSE,
    deleted_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE
);

-- Bảng 4: task_lists
-- Các cột/giai đoạn trong một dự án.
CREATE TABLE task_lists (
    id BIGSERIAL PRIMARY KEY,
    project_id BIGINT NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    position INT NOT NULL
);

-- Bảng 5: tasks
-- Lưu trữ các công việc.
CREATE TABLE tasks (
    id BIGSERIAL PRIMARY KEY,
    project_id BIGINT NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    task_list_id BIGINT REFERENCES task_lists(id) ON DELETE SET NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    priority task_priority DEFAULT 'normal',
    status task_status DEFAULT 'not-started',
    start_date DATE,
    end_date TIMESTAMP WITH TIME ZONE,
    is_completed BOOLEAN DEFAULT FALSE,
    is_deleted BOOLEAN DEFAULT FALSE,
    deleted_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE
);

-- Bảng 6: subtasks
-- Các công việc con.
CREATE TABLE subtasks (
    id BIGSERIAL PRIMARY KEY,
    task_id BIGINT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    is_completed BOOLEAN DEFAULT FALSE,
    position INT NOT NULL
);

-- Bảng 7: tags
-- Các nhãn được quản lý theo Workspace.
CREATE TABLE tags (
    id BIGSERIAL PRIMARY KEY,
    workspace_id BIGINT NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
    name VARCHAR(50) NOT NULL,
    color_hex VARCHAR(7) NOT NULL
);

-- Bảng 8: activities
-- Lưu trữ lịch sử hoạt động và thông báo.
CREATE TABLE activities (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    action_type activity_action_type NOT NULL,
    content TEXT NOT NULL,
    target_id BIGINT NOT NULL,
    target_type activity_target_type NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Bảng 9 -> 13: Các Bảng Nối (Junction Tables)

-- Bảng 9: workspace_members
-- Quản lý mối quan hệ nhiều-nhiều giữa người dùng và không gian làm việc.
CREATE TABLE workspace_members (
    workspace_id BIGINT NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role workspace_role NOT NULL,
    PRIMARY KEY (workspace_id, user_id)
);

-- Bảng 10: project_members
-- Quản lý thành viên trong một dự án.
CREATE TABLE project_members (
    project_id BIGINT NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role project_role NOT NULL,
    PRIMARY KEY (project_id, user_id)
);

-- Bảng 11: task_assignees
-- Quản lý người được giao việc cho một công việc.
CREATE TABLE task_assignees (
    task_id BIGINT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    PRIMARY KEY (task_id, user_id)
);

-- Bảng 12: project_tags
-- Quản lý các nhãn được gán cho một dự án.
CREATE TABLE project_tags (
    project_id BIGINT NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    tag_id BIGINT NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
    PRIMARY KEY (project_id, tag_id)
);

-- Bảng 13: notification_recipients
-- Quản lý người nhận thông báo.
CREATE TABLE notification_recipients (
    activity_id BIGINT NOT NULL REFERENCES activities(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    is_read BOOLEAN DEFAULT FALSE,
    PRIMARY KEY (activity_id, user_id)
);

-- Tạo chỉ mục (Indexes) để tăng tốc độ truy vấn
-- Gợi ý: Tạo chỉ mục cho tất cả các cột khóa ngoại và các cột thường dùng để lọc.
CREATE INDEX idx_projects_workspace_id ON projects(workspace_id);
CREATE INDEX idx_task_lists_project_id ON task_lists(project_id);
CREATE INDEX idx_tasks_project_id ON tasks(project_id);
CREATE INDEX idx_tasks_task_list_id ON tasks(task_list_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_priority ON tasks(priority);
CREATE INDEX idx_tasks_end_date ON tasks(end_date);
CREATE INDEX idx_subtasks_task_id ON subtasks(task_id);
CREATE INDEX idx_tags_workspace_id ON tags(workspace_id);
CREATE INDEX idx_activities_user_id ON activities(user_id);
CREATE INDEX idx_activities_target ON activities(target_id, target_type);